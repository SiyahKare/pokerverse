FROM node:20-alpine AS deps
WORKDIR /web
# Copy entire app dir to avoid stale package*.json cache mismatches
COPY pokerverse-miniapp/apps/web ./
RUN npm install

FROM node:20-alpine AS build
WORKDIR /repo
ARG VITE_WC_PROJECT_ID
ARG VITE_CHAIN_ID
ARG VITE_RPC_URL
ARG VITE_WS_URL
ARG VITE_USDC
ARG VITE_CHIPBANK
ARG VITE_BET
ENV VITE_WC_PROJECT_ID=${VITE_WC_PROJECT_ID}
ENV VITE_CHAIN_ID=${VITE_CHAIN_ID}
ENV VITE_RPC_URL=${VITE_RPC_URL}
ENV VITE_WS_URL=${VITE_WS_URL}
ENV VITE_USDC=${VITE_USDC}
ENV VITE_CHIPBANK=${VITE_CHIPBANK}
ENV VITE_BET=${VITE_BET}
COPY --from=deps /web/node_modules ./node_modules
# Copy app sources
COPY pokerverse-miniapp/apps/web ./apps/web
COPY pokerverse-miniapp/src ./src
WORKDIR /repo/apps/web
# Skip tsc, rely on Vite's transpile (type-checking CI’de yapılır)
RUN npx vite build

FROM nginx:alpine AS runtime
COPY --from=build /repo/apps/web/dist /usr/share/nginx/html
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]


